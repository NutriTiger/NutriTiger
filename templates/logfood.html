<!--==============================================================-->
<!-- logfood.html                                                   -->
<!--==============================================================-->

<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Log Food</title>
    {% include 'bootstrap.html' %}
</head>


<body>
    {% include 'navbar.html' %}
    {% set current_page = 'logfood' %}

    <h1 class="text-center m-5">Log Food</h1> 
    <p class="custom-text-wrapper">
        Select your dining hall from the drop down below or search for the recipe name in the 
        search bar. Once you select your dish(es), estimate the number of servings you consumed 
        in the “My Plate” window below. 
    </p>
    
    <!-- Select buttons: Dining Hall, Mealtime -->
    <div class="row p-1">
        <div class="col-sm-3 m-5">
            <select class="form-select form-select-sm" id = "diningHallSelect" aria-label="select_dhall" style="background-color: rgb(250, 160, 58);">
              <option value="Select Dining Hall" selected>Select Dining Hall</option>
              <option value="Center for Jewish Life">Center for Jewish Life</option>
              <option value="Forbes College">Forbes College</option>
              <option value="Graduate College">Graduate College</option>
              <option value="Yeh & New West Colleges">Yeh & New West Colleges</option>
              <option value="Rockefeller & Mathey Colleges">Rockefeller & Mathey Colleges</option>
              <option value="Whitman & Butler Colleges">Whitman & Butler Colleges</option>
            </select>
        </div>
    </div>

    <!-- Tab Navs -->


    <!--Two cards: one for the food list, and one for My Plate-->
    <div class="row p-2">
      <div class="col-md-6 m-3">

        <!-- Tab Navs -->
        <ul class="nav nav-tabs" id="mealTimeTab" role="tablist">
          {% if not is_weekend_var: %}
            <li class="custom-nav-item">
              <a class="nav-link active" id="Breakfast-tab" data-toggle="tab" href="#breakfast" role="tab" aria-controls="breakfast" aria-selected="true">Breakfast</a>
            </li>
            <li class="custom-nav-item">
              <a class="nav-link" id="Lunch-tab" data-toggle="tab" href="#lunch" role="tab" aria-controls="lunch" aria-selected="false">Lunch</a>
            </li>
          {% endif %}
          {% if is_weekend_var: %}
            <li class="custom-nav-item">
              <a class="nav-link active" id="Lunch-tab" data-toggle="tab" href="#lunch" role="tab" aria-controls="lunch" aria-selected="false">Brunch</a>
            </li>
          {% endif %}
          
          <li class="custom-nav-item">
              <a class="nav-link" id="Dinner-tab" data-toggle="tab" href="#dinner" role="tab" aria-controls="dinner" aria-selected="false">Dinner</a>
          </li>
        </ul>


        <div class="card">
          <div class="card-body" id="menu-items">
            <p class="text-center">Please select a dining hall from the dropdown menu.</p>
          </div>
        </div>

      </div>

      <!--My Plate Card (right side)-->
      <div class="col-sm-5 m-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title text-center">My Plate</h5>
            <p class="text-center">Select foods from the menu and add your estimated servings consumed.</p>
            <div id="my-plate"></div>
          </div>

          <!--My Plate Footer: display plate totals-->
          <div class="card-footer text-center">
            <strong>Plate Totals:</strong>
            <br>
            <div id="calTotal"> 
            </div>
            <div id="protTotal"> 
            </div>
            <div id="carbTotal"> 
            </div>
            <div id="fatTotal"> 
            </div>
          </div>

        </div>
      </div>
    </div>
    
    <div class="container p-5">
      <h4>Done adding food to your plate?</h4>
      <form action="/logfood" method="post" class="p-3">
        <button type="submit" class="btn btn-primary btn-lg btn-block" name="upload_plate">Upload Plate and Return</button>
      </form>
    </div>

</body>
<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
$(document).ready(function() {
    // Event listener for the dropdown selection change
    const diningHallSelect = document.getElementById('diningHallSelect');
    console.log(diningHallSelect);
    diningHallSelect.addEventListener('change', function() {
      var selectedHall = this.value; // Get the value of the selected option
      // Assume default or currently active mealtime
      var mealtime = $('.nav-tabs .active').attr('id').replace('-tab', '');
      console.log("Selected dining hall:", selectedHall, "Mealtime:", mealtime);

      if (selectedHall == "Select Dining Hall") {
        const p = document.createElement('p');
        p.classList.add('card-text'); 
        p.textContent = "Please select a dining hall from the dropdown menu."; 
        document.body.appendChild(p);
      }
      else {
      // Make an AJAX request
      fetchMenuData(selectedHall, mealtime);
      }
  })
  // Listener for tab switch
  $('#mealTimeTab a').on('shown.bs.tab', function(event) {
      var selectedHall = diningHallSelect.value; // Ensure diningHallSelect is defined outside this listener for scope
      var mealtime = $(event.target).attr('id').replace('-tab', ''); // Extract mealtime from the id of the activated tab

      console.log("Mealtime switched to:", mealtime);

      // Make an AJAX request if a dining hall is selected
      if (selectedHall !== "Select Dining Hall") {
        fetchMenuData(selectedHall, mealtime);
      }
  });
})
// Event listener for close buttons on My Plate
$(document).on('click', '.btn-close', function() {
  // Remove the card from the DOM
  $(this).closest('.food-row-wrap').remove();

  // Uncheck the food's checkbox

});

function fetchMenuData(hallId, mealtime) {
    var url = '/logfood/data?dhall=' + encodeURIComponent(hallId) + '&mealtime=' + encodeURIComponent(mealtime);
    fetch(url)
    .then(response => {
      // if (response.status === 404) {
      //   throw new Error('Not Found: The requested resource was not found');
      // }
      if (response.headers.get("content-type").includes("application/json")) {
        return response.json();
      } else {
        throw new Error('Received non-JSON response from server');
      }
    })
    .then(data => {
      console.log(data)
      updateMealContent(data);
    })
    .catch(error => console.error('Error fetching data:', error));
}
function updateMealContent(items) {
  console.log("in updateMealContnt")
  const container = document.getElementById('menu-items');
  // Ensure the container exists
  if (container) {
      container.innerHTML = '';
      if (Object.keys(items).length === 0) {
        // Handle no data case, e.g., display a message
        const p = document.createElement('p');
        p.textContent = "No data found.";
        container.appendChild(p);
      } 
      else {
        // Iterate over the dictionary entries
        Object.entries(items).forEach(([item, dict]) => {
            console.log(dict);
            const div = document.createElement('div'); // Create a div for each item
            div.classList.add('form-check'); // Bootstrap class for checkbox styling

            const checkbox = document.createElement('input'); // Create the checkbox
            checkbox.type = 'checkbox';
            checkbox.classList.add('form-check-input'); // Bootstrap class for checkbox styling
            checkbox.id = 'checkbox-' + dict['recipeid']; // Use the ID from the dictionary

            const label = document.createElement('label'); // Create a label for the checkbox
            label.classList.add('form-check-label'); // Bootstrap class for label styling
            label.htmlFor = checkbox.id; // Associate label with checkbox
            label.textContent = dict['mealname']; // Set label text to the item name

            // Create a paragraph for nutrition facts
            const nutritionFacts = document.createElement('p');
            nutritionFacts.classList.add('nutrition-facts'); // Optional: add a class for styling
            // Assuming nutrition data is in a string or formatted how you want it in dict
            nutritionFacts.textContent = 'Serving Size: ' + dict['servingsize'] + ', Calories: ' + dict['calories'] + ', Protein: ' + dict['proteins'] + 'g' + ', Carbs: ' + dict['carbs'] + 'g' + ', Fats: ' + dict['fats'] + 'g'; // Example format

            // Event listener for the checkbox
            checkbox.addEventListener('change', handleCheckboxChange);

            div.appendChild(checkbox); // Append the checkbox to the div
            div.appendChild(label); // Append the label to the div
            div.appendChild(nutritionFacts);

            container.appendChild(div); // Append the div to the container
        });
      }
      
  } else {
      console.error('Container not found for meal');
  }
}
// Function to handle checkbox change event
function handleCheckboxChange() {
    if (this.checked) {
        console.log("Checkbox with ID " + this.id + " was checked.");
        // Find the associated label element
        const label = document.querySelector('label[for="' + this.id + '"]');
        // Access the text content of the label
        const labelText = label.textContent;
        console.log("Food item: " + labelText);

        const row = document.createElement('div');
        const recId = this.id.substring(9);
        console.log(recId)
        row.id = "foodplate-" + recId;
        row.classList.add('row');

        // create a border around each food row
        const rowWrapper = document.createElement('div');
        rowWrapper.classList.add('food-row-wrap','card', 'border-primary', 'p-3', 'mb-3'); // Add border and padding classes to the wrapper

        const labelColumn = document.createElement('div');
        labelColumn.classList.add('col');
        labelColumn.textContent = labelText;

        //  <div class="card border-primary" id="{{entry}}" style="padding: 10px;">
        const servingsColumn = document.createElement('div');
        servingsColumn.classList.add('col', 'd-flex', 'align-items-center', 'justify-content-end');
        const servingsInput = document.createElement('input');
        servingsInput.type = 'serving';
        servingsInput.classList.add('form-control', 'small-input')
        servingsInput.placeholder = 'Servings';
        servingsInput.addEventListener('input', function(event) {
            // This function is called every time the user changes the input
            console.log('Servings changed to: ', event.target.value);
            const calTotal = document.getElementById('calTotal')
            // NEED TO FIGURE OUT HOW TO CALCULATE PLATE TOTALS
            calTotal.innerText = event.target.value
        });
        const closeButton = document.createElement('button');
        closeButton.classList.add('btn-close', 'btn-sm', 'aria-label="Close"');
        servingsColumn.appendChild(servingsInput);
        servingsColumn.appendChild(closeButton);
        
        row.appendChild(labelColumn);
        row.appendChild(servingsColumn);
        
        rowWrapper.appendChild(row); // Append the row to the wrapper
        document.getElementById('my-plate').appendChild(rowWrapper); // Append the wrapper to the container

    } else {
        console.log("Checkbox with ID " + this.id + " was unchecked.");
        const retrieved_recId = this.id.substring(9);
        const plateID = "foodplate-" + retrieved_recId;
        console.log("recid for remove: " + plateID)

        const row = document.getElementById(plateID)
        
        if (row) {
          // access wrapper to delete both border & the actual row
          const wrapper = row.closest('.food-row-wrap');
          if (wrapper) {
              wrapper.remove();
          }
        }
    }
}

</script>
</html>