{% extends "layout.html" %}
{% set current_page = 'editingplate' %}
{% block title %}My Homepage{% endblock %}
{% block content %}
    <h1 class="text-center m-3">Editing My Plate</h1> 
    <h3 class="text-center m-3 text-muted">Good {{ampm}}, {{netid}}.</h3>

    <!--Layout for the two main cards-->
    <div class="row p-5">
        <div class="col-sm-9 mx-auto">
          <div class="card">
            <div class="card-body">

                <!--My Plate (right card)-->
                <h4 class="text-center py-3">My Plate</h4>

                <!--Create a card for each entry-->
                <div class="col">
                    {% for entry, foods in entries_food_dict.items() %}
                    <div class="row-cols-1 p-2">
                        <div class="card border-primary" id="{{ entry }}" style="padding: 10px;">
                            <div class="card-body">
                                <div class="header-container">
                                    <h5 class="card-title py-1">{{entry}}</h5>
                                    <form action="/editingplate" method="post">
                                        <input type="hidden" name="card_id" value="{{ entry }}">
                                        <button type="submit" data-entry-id="{{ entry }}" class="btn-close" aria-label="Close"></button>
                                    </form>
                                </div>

                                <!--Create a bordered element for each food in the entry-->
                                <ul class="list-group">
                                    {% for food in foods %}
                                    <!--Border with close buttons for each food-->
                                    <div class="card border-primary p-2 mb-3" id="myplate-{{ uniqueid }}">
                                        <div class="row">
                                            <div class="col">
                                                <!-- Food name label-->
                                                <span>{{ food }}</span>
                                            </div>
                                            <div class="col-auto d-flex align-items-center">
                                                <!-- Serving Lineedit Column and Close button -->
                                                <div id="new_entry" class="d-flex align-items-center">
                                                    <!-- Serving Lineedit -->
                                                    <input type="number" min="0" class="form-control small-input mr-2" data-cals="{{ cals }}"
                                                    data-recid="{{ recid }}" data-carbs="{{ carbs }}" data-fats="{{ fats }}" data-prots="{{ prots }}"
                                                    placeholder="Servings" oninput="handleServingChange()" required
                                                    onkeypress="return isValid(event)">
                                    
                                                    <!-- Close button -->
                                                    <button type="button" id="close-{{ uniqueid }}" class="btn btn-close btn-sm" aria-label="Close"
                                                    data-checkid="{{ checkid }}" data-myplateid="myplate-{{ uniqueid }}"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </ul>

                            </div>                             
                        </div>
                    </div>

                {% endfor %}

                <!--Save plate button-->
                <div class="py-3">
                    <form action="/editingplate" method="post">
                        <button id="savePlate" type="submit" name="save_plate" class="btn btn-secondary btn-lg btn-block">Save Plate</button>
                    </form>
                </div>
                
            </td>

        </tr>
    </table>

    <script>

        // List of deleted entries' indices
        let deletedEntries = [];
        // List of lists of deleted foods & their entries
        let deletedFoods = [];

        function appendEntrytoDelete(entryId) {
            
            // Get index of entry from "entry" string
            var entry = document.getElementById(entryId).dataset.id;
            var entryIndex = parseInt(entry.substring(5));
            console.log(entryIndex);
            // append to deletedEntriesList
            deletedEntries.push(entryIndex);
        }

        function appendFoodtoDelete(entryId, foodId) {

            // make entryId an index 
            var entry = document.getElementById(entryId).dataset.id;
            var entryIndex = parseInt(entry.substring(5));

            // append to deleted foods list at the index that corresponds to its entry
            deletedFoods[entryIndex].push(foodId);
        }

        // once an entry has been appended to be deleted, hide it from view
        function hideEntry(entryId) {
            document.getElementById(entryId).style.display = "none";
        }

        // once an entry has been appended to be deleted, hide it from view
        function hideFood(foodId) {
            document.getElementById(foodId).style.display = "none";
        }

        // Serving input validation function
        function isValid(input) {
            var charCode = input.which || input.keyCode;
            var value = input.target.value;
        
            // If the pressed key is a '-'
            if (input.charCode === 45)
                return false;
        
            // If the key contains nonvalid chars 
            if ((input.charCode < 48 || input.charCode > 57) && input.charCode !== 46)
                return false;
        
            // Allow only 2 decimal places
            if (value.indexOf('.') !== -1 && value.length - value.indexOf('.') > 2)
                return false;
        
            return true;
        }

        // Event listener for close (X) buttons
        document.addEventListener('click', function(event) {

            // If an entry was deleted 
            if (event.target.classList.contains('btn-close')) {

                console.log("delete entry button clicked");
                var entryId = event.target.dataset.entryId;
                // append to list and hide from view
                appendEntrytoDelete(entryId);
                hideEntry(entryId);      
            }

            // If a food was deleted
            else if (event.target.classList.contains('btn-sm')) {

                console.log("delete a food button clicked");
                var foodId = event.target.dataset.myplateid;
                // append to list and hide from view
                // get entryId of this food
                appendFoodtoDelete(foodId);
                hideFood(foodId);
            }
        });
        
        // once submit button is clicked, send everything to be deleted as an AJAX call
        document.getElementById('savePlate').addEventListener('click', function(event) {
	    
	        console.log("save plate button clicked");
            
            // Send AJAX request with everything to delete
            $.ajax({
                url: '/editingplate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ "deletedEntries": deletedEntries, "deletedFoods":deletedFoods }),
                success: function(response) {
                    console.log('Data sent successfully:', response);
                },
                error: function(xhr, status, error) {
                    console.error('Error sending data:', error);
                }
            });

        });

        </script>
{% endblock %}