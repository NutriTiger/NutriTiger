{% extends "layout.html" %}
{% set current_page = 'editingplate' %}
{% block title %}My Homepage{% endblock %}
{% block content %}
    <h1 class="text-center m-3">Editing My Plate</h1> 
    <h3 class="text-center m-3 text-muted">Good {{ampm}}, {{netid}}.</h3>

    <!--Layout for the two main cards-->
    <div class="row p-5">
        <div class="col-sm-6">
          <div class="card">
            <div class="card-body">
                <!--My Macros (left card)-->
              <h4 class="text-center py-3">My Macros</h4>
              <h5 class="text-center">Daily calorie goal: {{cal_goal}}cal</h5>

              <div class="prog-container my-2" style="display: flex; justify-content: center;">
                <div class="progress" style="height: 50px; width: 300px;">
                  <div class="progress-bar dynamic-progress-bar" 
                      role="progressbar" 
                      style="width: {{ (curr_caltotal / cal_goal) * 100 }}%; background-color: rgb(66, 142, 223);" 
                      aria-valuenow="{{curr_caltotal}}" 
                      aria-valuemin="0" 
                      aria-valuemax="{{cal_goal}}">{{ curr_caltotal }}cal
                  </div>
                </div>
            </div>  
                
                  <div class="prog-container my-5" style="display: flex; justify-content: center;">
                    <div style="width: 400px; height: 400px; display: flex; justify-content: center;">
                      {% include 'piechart.html' %}
                  </div>
                </div>

            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="card">
            <div class="card-body">
                <!--My Plate (right card)-->
                <h4 class="text-center py-3">My Plate</h4>
                <!--Create a card for each entry-->
                <div class="col">
                    {% for entry, foods in entries_food_dict.items() %}
                    <div class="row-cols-1 p-2">
                        <div class="card border-primary" id="{{entry}}" style="padding: 10px;">
                            <div class="card-body">
                                <div class="header-container">
                                    <h5 class="card-title py-1">{{entry}}</h5>
                                    <form action="/editingplate" method="post">
                                        <input type="hidden" name="card_id" value="{{ entry }}">
                                        <button type="submit" data-cardid="{{entry}}" class="btn-close" aria-label="Close"></button>
                                    </form>
                                </div>
                                <ul class="list-group">
                                    {% for food in foods %}
                                    <!--Border with close buttons for each food-->
                                    <div class="card border-primary p-2 mb-3" id="myplate-{{ uniqueid }}">
                                        <div class="row">
                                            <div class="col">
                                                <!-- Food name label-->
                                                <span>{{ food }}</span>
                                            </div>
                                            <div class="col-auto d-flex align-items-center">
                                                <!-- Serving Lineedit Column and Close button -->
                                                <div id="new_entry" class="d-flex align-items-center">
                                                    <!-- Serving Lineedit -->
                                                    <input type="number" min="0" class="form-control small-input mr-2" data-cals="{{ cals }}"
                                                    data-recid="{{ recid }}" data-carbs="{{ carbs }}" data-fats="{{ fats }}" data-prots="{{ prots }}"
                                                    placeholder="Servings" oninput="handleServingChange()" required
                                                    onkeypress="return isValid(event)">
                                    
                                                    <!-- Close button -->
                                                    <button type="button" id="close-{{ uniqueid }}" class="btn btn-close btn-sm" aria-label="Close"
                                                    onclick="closeMyPlate(this)" data-checkid="{{ checkid }}" data-myplateid="myplate-{{ uniqueid }}"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </ul>
                            </div>
                                                        
                    </div>
                </div>

                {% endfor %}

                <!--"Click to add an entry"-->
                <div class="p-3">
                    <form action="/editingplate" method="post">
                        <center>
                            <button type="submit" name="add_entry" class="btn btn-primary btn-lg btn-block">+ Click to add an Entry</button>
                        </center>
                    </form>
                </div>

                <div class="py-3">
                    <form action="/editingplate" method="post">
                        <button type="submit" name="save_plate" class="btn btn-secondary btn-lg btn-block">Save Plate</button>
                    </form>
                </div>
                
            </td>

        </tr>
    </table>

    <script>

        function isValid(input) {
            var charCode = input.which || input.keyCode;
            var value = input.target.value;
        
            // If the pressed key is a '-'
            if (input.charCode === 45)
                return false;
        
            // If the key contains nonvalid chars 
            if ((input.charCode < 48 || input.charCode > 57) && input.charCode !== 46)
                return false;
        
            // Allow only 2 decimal places
            if (value.indexOf('.') !== -1 && value.length - value.indexOf('.') > 2)
                return false;
        
            return true;
        }
        </script>
{% endblock %}