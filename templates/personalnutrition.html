{% extends "layout.html" %}
{% set current_page = 'personalfood' %}
{% block title %}Personal Nutrition{% endblock %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous" async></script>
<div id="loading-animation" class="loading-animation" style="display: none;">
    <div class="loading-spinner"></div>
</div>
<div class = "p-5">
    <div class = "text-center">
        <h1 class="display-3 pb-2"><strong>My Custom Foods</strong></h1>
        <h5 class="text-center px-2">See an overview of your custom foods and add to your collection of recipes.</h5>
    </div>
    <div class="text-center p-3">
        <div class="d-inline-block">
            <a href="{{ url_for('personal_food') }}" class="btn btn-primary">+ Add a custom food</a>
        </div>
        <div class="d-inline-block">
            <button type="submit" id="edit_custom_foods" class="btn btn-primary" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                </svg>
                Edit Custom Foods
            </button>
        </div>
        <div class="d-inline-block">
            <button type="submit" id="save_edits" class="btn btn-primary" style="display: none;">
                Save Edits
            </button>
        </div>
    </div>
    <br>
{% if user_nutrition is not none %}
<script>document.getElementById('edit_custom_foods').style.display="block"</script>
<div id = "masonry-grid" class="py-3 row g-4 justify-content-center" data-masonry='{"percentPosition": true }'>
    {% for item in user_nutrition %}
    <div class="col col-md-4 col-xl-3 col-xxl-2">
        <div class="card h-100" id="{{ loop.index }}">
            <div class="deleted-overlay">Deleted</div>
            <div class="card-body">
                <div class="header-container"> <!-- Utilizing flex layout -->
                    <h5 class="card-title text-center"></h5><b>{{ item['mealname'] }}</b></h5>
                    <button type="button" id = "btn-{{ loop.index}}" class="btn btn-close btn-sm" aria-label="Close" style="display: none;"
                            onclick="deleteCustomFood(this)" data-cardid="{{ loop.index }}" data-recid="{{ item['recipeid'] }}">
                    </button>
                </div>
            </div>
            <ul class="list-group list-group-flush">
                {% if item['image_url'] %}
                    <li class="list-group-item"><img src="{{ item['image_url'] }}" alt="Meal Image" class = "fitted-image"></li>
                {% endif %}
                {% if item['description'] != '' %}<li class="list-group-item"><strong>Description: </strong>{{ item['description']}}</li>{% endif %}
                <li class="list-group-item"><strong>Serving size:</strong> {{ item['servingsize']}}</li>
                <li class="list-group-item"><strong>Calories:</strong> {{ item['calories']}}</li>
                <li class="list-group-item"><strong>Proteins:</strong> {{ item['proteins']}}g</li>
                <li class="list-group-item"><strong>Carbs:</strong> {{ item['carbs'] }}g</li>
                <li class="list-group-item"><strong>Fats:</strong> {{ item['fats'] }}g</li>
              </ul>
            <div class="card-footer">
                <small class="text-body-secondary">Created on {{ custom_strftime(item['date']) }}</small>
            </div>
        </div>
    </div>
    {% endfor %}
   
</div>
{% else %}
<div class="mx-auto" style="padding: 15px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <div class="text-center text-muted p-5"><h1>No custom foods found.</h1></div>
</div>
{% endif %}

</div>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
<script>
let deletedFoods = []
function deleteCustomFood(item) {
    var recid = item.dataset.recid;
    var cardid = item.dataset.cardid;
    var btnid = "btn-" + cardid
    let card = document.getElementById(cardid);
    let overlay = card.querySelector('.deleted-overlay');
    let button = document.getElementById(btnid)
    $(button).remove()
    overlay.style.display = 'flex'; 
    deletedFoods.push(recid)
}
function showLoadingAnimation() {
    // Show the loading animation covering the entire screen
    $("#loading-animation").show();
}
function hideLoadingAnimation() {
    // Show the loading animation covering the entire screen
    $("#loading-animation").hide();
}
function save_edits() {
    var dataToSend = {
        deletedFoods: deletedFoods
    };
    var jsonData = JSON.stringify(dataToSend);
    
    showLoadingAnimation()
    $.ajax({
        type: "POST",
        url: "/personalnutrition",
        contentType: "application/json",
        data: jsonData,
        success: function (response) {
            console.log("Data sent successfully:", response);
            // Check if the server response includes the redirect URL
            if (response.success && response.redirect) {
                // Hide the loading animation before redirection
                window.location.href = response.redirect;
                // Delay the redirection slightly to ensure the loading animation is hidden
            }
        },
        error: function (xhr, status, error) {
            hideLoadingAnimation()
            console.error("Error in data submission:", xhr.status, xhr.responseText);
        },
    });
}
$(document).ready(function(){
    $('#edit_custom_foods').click(function() {
        console.log("edit clicked")
        $('#edit_custom_foods').css('display', 'none')
        $('#save_edits').css('display', 'block')
        $('.btn-close').each(function() {
            $(this).css('display', 'block');
        });
    });
    $('#save_edits').click(function() {
        $('#save_edits').css('display', 'none')
        $('#edit_custom_foods').css('display', 'block')
        $('.btn-close').each(function() {
            $(this).css('display', 'none');
        });
        save_edits();
    });
    // Initialize Masonry after all images have loaded
    $('#masonry-grid').imagesLoaded(function(){
        $('#masonry-grid').masonry({
            // Masonry options
            itemSelector: '.col',
            percentPosition: true
        });
    });
});
</script>
{% endblock %}
